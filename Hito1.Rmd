---
title: "Hito1"
author: "mineria"
date: "9/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
## HITO 1: Análisis clientes Block 
María Hernández, Sebastián Moreno, Lung Pang, Cristóbal Saldías, Víctor Vidal.
Septiembre 2021





1 Introducción

Blockstore es una cadena de tiendas, ubicada en Chile, enfocada la venta de zapatillas, accesorios y vestuario de las mejores marcas urbanas.
Dada la contingencia mundial de la pandemia y el estallido social del 2019, Block tuvo que adaptarse al canal de ventas online por lo que la necesidad de la aplicación de análisis de datos y en particular de minería de datos va en el contexto cambiante en el ámbito nacional, donde la crisis social, pandemia, mayor dinero circulante y un aumento explosivo en ventas online hacen necesario tener las mejores estrategias diferenciadas para cada cliente,

Es por esto que decidimos estudiar el comportamiento de compra de los clientes a nivel nacional.
Nos parece interesante estudiar estos datos para generar más ventas enfocando una estrategia de negocios diferenciada para cada grupo de clientes en específico de acuerdo a sus gustos.


2 Exploración de Datos

```{r}
# Asignamos nuestro "working directory" (set w. d.) como el directorio ~/RDATA
setwd("~/RDATA/")
```
# Cargamos los datos originales 
Sin embargo, estos datos no están limpios debido a que los clientes no ingresaron bien los datos, por lo que se realizó una limpieza de los datos para poder trabajar de mejor manera.
```{r}
pedidos_preeliminar <- read.csv("orders.csv", encoding = "UTF-8")
pedidos_detalle_preeliminar <-read.csv("order_detail.csv", encoding = "UTF-8")
```

# A modo de resumen se deja un head y la cantidad de columnas y filas de cada dataset
```{r}
head(pedidos_preeliminar)
head(pedidos_detalle_preeliminar)
nrow(pedidos_preeliminar)
ncol(pedidos_preeliminar)
nrow(pedidos_detalle_preeliminar)
ncol(pedidos_detalle_preeliminar)

```
Para la limpieza se eliminaron filas vacías, datos "dummy" realizados por la empresa, y otros valores incosistentes y repetitivos.
También se hizo un refactoring de los nombres de las columnas para un mejor entendimiento del dataset.
```{r}

pedidos<-read.csv("Orders_OFICIAL.csv", encoding = "UTF-8", sep=";")
pedidos_detalle <-read.csv("ORDER_DETAIL_OFICIAL.csv", encoding = "UTF-8",sep=";")
pedidos$count <- as.numeric(ave(pedidos$Comuna, pedidos$Comuna, FUN = length))
pedidos_detalle$count.marca <- as.numeric(ave(pedidos_detalle$Marca, pedidos_detalle$Marca, FUN = length))


```
Dejamos un resumen del data pedidos

```{r}
(pedidos)
nrow(pedidos)
ncol(pedidos)

```
Dejamos un resumen del data pedidos_detalle

```{r}
(pedidos_detalle)
nrow(pedidos_detalle)
ncol(pedidos_detalle)
```


```{R}

pedidos$Fecha.Compra <- as.Date(pedidos$Fecha.Compra, format ="%d-%m-%Y")
(pedidos)


pedidos_detalle$Fecha.Pedido <- as.Date(pedidos_detalle$Fecha.Pedido, format ="%Y-%m-%d")
pedidos_detalle$anio <- as.numeric(format(pedidos_detalle$Fecha.Pedido,'%Y'))

(pedidos_detalle)

```

```{r}
summary(pedidos)
summary(pedidos_detalle)
```

```{R}
library(ggplot2)
```





##A continuación les dejaremos el estudio de datos sobre nuestro dataset

#A grandes razgos podemos calcular la cantidad promedio que se gasta una persona en Block
```{r}
nfilas <- nrow(pedidos)

total_vendido <- sum(pedidos$Precio.Pedido)
promedio_pedidos <- total_vendido/nfilas
(promedio_pedidos)
```


# Vamos a ver primero la cantidad de gente que pide más y menos que el promedio 
```{r}



#La gente que pide mas que el promedio

pedidos_RM_mayorpromedio <- data.frame(pedidos[pedidos$REGION.CON.CODIGO == "RM" &
                                       pedidos$Precio.Pedido > promedio_pedidos,] )
nrow(pedidos_RM_mayorpromedio)

#La gente que pide menos que el promedio

pedidos_RM_menorpromedio <- data.frame(pedidos[pedidos$REGION.CON.CODIGO == "RM" &
                                       pedidos$Precio.Pedido <= promedio_pedidos,] )
nrow(pedidos_RM_menorpromedio)

```

##El pedido mas caro en block online
## Podemos ver que en la tabla pedidos_Detalles según el numero de pedido podemos ver el detalle
## de la compra que realizó la clienta.
```{R}

pedidos[which.max(pedidos$Precio.Pedido),]
#usamos su numero de pedido para ver las compras realizadas
pedido_maximo_detalle <- pedidos_detalle[pedidos_detalle$Numero.Pedido == "#BL4499",]
#verificamos el dinero sea consistente en ambas tablas
sum(pedido_maximo_detalle$Precio.Total.Productos)
```

# La cantidad de pedidos divididos por región

```{r}

ggplot(pedidos, aes(x = REGION.CON.CODIGO),) +
   ggtitle("Cantidad de pedidos por región") +
  geom_bar()

```


# Cantidad de pedidos dividos por comuna 
```{R}


freq_comuna <- data.frame(comuna = pedidos$Comuna, count = pedidos$count)
freq_comuna <-  unique(freq_comuna)
freq_comuna <- freq_comuna[order(freq_comuna[,"count"], decreasing = TRUE),]

(freq_comuna)

ggplot(freq_comuna[1:30,], aes(x = reorder(comuna , count),
                     y = count)) +
   ggtitle("Las 30 Comunas con mas pedidos del pais") +
  coord_flip() +
  geom_bar(stat = "identity")
```
# Puente alto y Las condes son de las comunas más pobladas de la RM
# Puente alto es una de las comunas más "zapatilleras" vs "Las condes" que es una comuna
# que tiende mas a la ropa formal y a continuación veremos la cantidad de pedidos, el promedio de estos y la suma total de dinero de las respectivas comunas

```{r}
pedidos_comuna_Lascondes <- data.frame(pedidos[pedidos$Comuna == "LAS CONDES", ] )
(pedidos_comuna_Lascondes)
nrow(pedidos_comuna_Lascondes)
mean(pedidos_comuna_Lascondes$Precio.Pedido)
sum(pedidos_comuna_Lascondes$Precio.Pedido)


pedidos_comuna_puentealto <- data.frame(pedidos[pedidos$Comuna == "PUENTE ALTO", ] )
(pedidos_comuna_puentealto)
nrow(pedidos_comuna_puentealto)
mean(pedidos_comuna_puentealto$Precio.Pedido)
sum(pedidos_comuna_puentealto$Precio.Pedido)


```


# Se deja un historial de pedidos desde el inicio del dataset hasta la ultima fecha presente
# 
```{r}
library(ggplot2)
ggplot(pedidos, aes(x = Fecha.Compra) ) +
  geom_bar() +
  scale_x_date(date_breaks = "1 month",
             date_labels = "%b") +
  labs(title = "Compras a lo largo del tiempo",
       x = "fecha",
       y = "Cantidad de pedidos")

```
# Vamos a ver cuanto se ha vendido en block por marca
```{r}



freq_marca <- data.frame(marca = pedidos_detalle$Marca, count = pedidos_detalle$count.marca)
freq_marca <-  distinct(freq_marca)
freq_marca <- freq_marca[order(freq_marca[,"count"], decreasing = TRUE),]

(freq_marca)

ggplot(freq_marca[1:30,], aes(x = reorder(marca , count),
                     y = count)) +
   ggtitle("Las 30 Marcas con mas pedidos del pais") +
  coord_flip() +
  geom_bar(stat = "identity")

```

# Vamos a ver cuanto se ha vendido en block por marca
```{r}


precio_marca <- data.frame(marca = pedidos_detalle$Marca, precio = pedidos_detalle$Precio.Producto)


(precio_marca)

ggplot(pedidos_detalle, aes(x = Marca, y = Precio.Producto)) +
  geom_boxplot()+
  coord_flip() +
  ggtitle("Precios de la marca")

```
# Marca mas vendida por año


ggplot(pedidos_detalle[pedidos_detalle$Marca, ], 
       aes(x=Marca, y=count.marca)) +
  coord_flip() +
  geom_bar(stat="identity")


```{r}




  
```


Preguntas y problemas: Dada la exploración anterior y su motivación original, formular preguntas que se pueden responder mediante la minería de datos y que se puedan vincular a la problemática planteada en la motivación

¿Cómo se relaciona el precio de la compra con el lugar desde donde se pidió?(regiones piden paquetes más caros? )
¿Qué marcas se compran más según el sector?
¿Qué productos se compran juntos?
¿Existe una tendencia en la segunda compra con respecto a la primera?(se compra la misma marca 2 veces?)
¿Qué producto puede que compre alguien que ya adquirió x producto?  
